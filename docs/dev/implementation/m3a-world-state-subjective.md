# Milestone 3 â€” Subjective World State (Player Knowledge Model)

## Purpose
Create the player-owned knowledge layer that captures hypotheses, uncertainty, and notes. This model must reference artefacts generated in M1 and the objective world state defined in M2, enabling contradictions and retcons later.

## Objectives
- Define subjective knowledge structures for **hypotheses**, **confidence**, and **notes**.
- Attach subjective data to artefacts generated by the M1 pipeline.
- Surface a UI for artefact inspection and note-taking.
- Prepare data structures for contradiction tracking (M4).

## Subjective State Data Model (TypeScript)
```ts
export type Hypothesis = {
	id: string;
	artefactId: string;
	claim: string;
	confidence: 'low' | 'medium' | 'high';
	createdAt: string;
	updatedAt: string;
	status: 'active' | 'retired';
};

export type PlayerNote = {
	id: string;
	artefactId: string;
	content: string;
	createdAt: string;
	updatedAt: string;
};

export type SubjectiveWorldState = {
	hypotheses: Hypothesis[];
	notes: PlayerNote[];
};
```

## Subjective State Store (TypeScript)
```ts
import type { SubjectiveWorldState, Hypothesis, PlayerNote } from '$lib/types/subjective';

const state = $state<SubjectiveWorldState>({
	hypotheses: [],
	notes: []
});

export const subjectiveWorldState = {
	get hypotheses() {
		return state.hypotheses;
	},
	get notes() {
		return state.notes;
	},
	addHypothesis(input: Omit<Hypothesis, 'id' | 'createdAt' | 'updatedAt' | 'status'>) {
		const now = new Date().toISOString();
		state.hypotheses = [
			...state.hypotheses,
			{ ...input, id: crypto.randomUUID(), createdAt: now, updatedAt: now, status: 'active' }
		];
	},
	updateHypothesis(id: string, patch: Partial<Hypothesis>) {
		const now = new Date().toISOString();
		state.hypotheses = state.hypotheses.map((hypothesis) =>
			hypothesis.id === id ? { ...hypothesis, ...patch, updatedAt: now } : hypothesis
		);
	},
	addNote(input: Omit<PlayerNote, 'id' | 'createdAt' | 'updatedAt'>) {
		const now = new Date().toISOString();
		state.notes = [
			...state.notes,
			{ ...input, id: crypto.randomUUID(), createdAt: now, updatedAt: now }
		];
	},
	updateNote(id: string, patch: Partial<PlayerNote>) {
		const now = new Date().toISOString();
		state.notes = state.notes.map((note) =>
			note.id === id ? { ...note, ...patch, updatedAt: now } : note
		);
	}
};
```

## Artefact Inspection UI (Svelte outline)
```svelte
<script lang="ts">
	import type { GeneratedArtefact } from '$lib/types/artefact';
	import { subjectiveWorldState } from '$lib/stores/subjectiveWorldState.svelte';

	export let artefact: GeneratedArtefact;

	let claim = '';
	let confidence: 'low' | 'medium' | 'high' = 'medium';
	let note = '';

	function addHypothesis() {
		subjectiveWorldState.addHypothesis({
			artefactId: artefact.id,
			claim,
			confidence
		});
		claim = '';
	}

	function addNote() {
		subjectiveWorldState.addNote({
			artefactId: artefact.id,
			content: note
		});
		note = '';
	}
</script>

<section class="card bg-base-200">
	<div class="card-body">
		<h3 class="card-title">Artefact Inspection</h3>
		<p class="text-sm">{artefact.blueprintId}</p>
		<ul>
			{#each artefact.parts as part}
				<li>{part.partId}: {part.materialId}</li>
			{/each}
		</ul>

		<div class="divider">Hypothesis</div>
		<input class="input" bind:value={claim} placeholder="Claim" />
		<select class="select" bind:value={confidence}>
			<option value="low">Low</option>
			<option value="medium">Medium</option>
			<option value="high">High</option>
		</select>
		<button class="btn btn-primary" on:click={addHypothesis}>Add Hypothesis</button>

		<div class="divider">Notes</div>
		<textarea class="textarea" bind:value={note} placeholder="Observation" />
		<button class="btn" on:click={addNote}>Add Note</button>
	</div>
</section>
```

## Subjective State Persistence (JSON example)
```json
{
	"hypotheses": [
		{
			"id": "h-001",
			"artefactId": "a-001",
			"claim": "Obsidian is used for ceremonial blades.",
			"confidence": "medium",
			"createdAt": "2026-01-13T12:00:00Z",
			"updatedAt": "2026-01-13T12:00:00Z",
			"status": "active"
		}
	],
	"notes": [
		{
			"id": "n-001",
			"artefactId": "a-001",
			"content": "Blade shows ornate etching along the spine.",
			"createdAt": "2026-01-13T12:05:00Z",
			"updatedAt": "2026-01-13T12:05:00Z"
		}
	]
}
```

## Integration with Objective World State (M2)
- When creating hypotheses, show **culture** and **period** metadata from the objective world state to encourage hypothesis grounding.
- Prepare a structure to compare hypotheses to objective facts later (M4).

## Testing Plan
- Unit tests for add/update hypothesis and note behaviors.
- UI test to ensure artefact inspection writes correct data into subjective state.

## Definition of Done
- Subjective world state exists with hypotheses and notes per artefact.
- Artefact inspection UI writes to subjective state.
- Data model is ready for contradiction evaluation and retcon logic.
